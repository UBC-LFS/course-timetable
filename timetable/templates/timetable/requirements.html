{% extends "timetable/base.html" %}
{% load static %}

{% block content %}
<div class="container py-4">

  <h2 class="mb-3">Program Requirements</h2>

  <form method="get" class="row g-3 align-items-end">
    <div class="col-md-4">
      <label class="form-label">Program Name *</label>
      <select id="program-select" name="program" class="form-select">
        <option value="">-- Select Program --</option>
        {% for name in program_names %}
          <option value="{{ name.name }}" {% if name.name == selected_program_name %}selected{% endif %}>{{ name.name }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-4">
      <label class="form-label">Program Year Level *</label>
      <select id="level-select" name="level" class="form-select" disabled>
        <option value="">-- Select Year Level --</option>
      </select>
    </div>

    <div class="col-md-4">
      <button type="submit" name="search" value="1" class="btn btn-primary">Search</button>
    </div>
  </form>

  {% if submitted %}
    {% if not_found %}
      <!-- actually no need anymore, because a program must have a year level -->
      <div class="alert alert-warning mt-4">No such program exists.</div>
    {% else %}
      {% if not display_program_name or not display_level_name %}
        <!-- do nothing -->
      {% else %}
        <p class="text-muted mb-4">
                Program: <strong>{{ display_program_name }}</strong> Level: <strong>{{ display_level_name }}</strong>
        </p>  

        <div class="table-wrapper table-responsive mt-4">
            <table class="table table-bordered table-striped table-hover text-center">
            <thead>
                <tr>
                <th>Code</th><th>Number</th>
                </tr>
            </thead>
            <tbody>
            {% for c in courses %}
                <tr>
                <td>{{ c.code.name }}</td>
                <td>{{ c.number.name }}</td>
                </tr>
            {% empty %}
                <tr><td colspan="2">No courses found.</td></tr>
            {% endfor %}
            </tbody>
            </table>
        </div>
      {% endif %}
    {% endif %}
  {% endif %}

</div>
{% endblock %}

{% block js %}
<script>
  (function() {
    const programSel = document.getElementById('program-select');
    const levelSel   = document.getElementById('level-select');
  
    function resetLevels() {
      levelSel.innerHTML = '<option value="">-- Select Year Level --</option>';
    }
  
    async function loadLevelsFor(programName) {
      resetLevels();
      if (!programName) {
        levelSel.disabled = true;
        return;
      }
      try {
        const resp = await fetch("{% url 'scheduler:ajax_levels_for_program' %}?program=" + encodeURIComponent(programName));
        const data = await resp.json();
        for (const lvl of data.levels) {
          const opt = document.createElement('option');
          opt.value = opt.textContent = lvl;
          levelSel.appendChild(opt);
        }
        levelSel.disabled = data.levels.length === 0; // stays disabled if none
      } catch (e) {
        // fallback: keep it disabled on error
        levelSel.disabled = true;
      }
    }
  
    // On change, (re)populate year levels for the chosen program
    programSel.addEventListener('change', (e) => loadLevelsFor(e.target.value));
  })();
</script>
{% endblock %}
