{% extends "timetable/base.html" %}
{% load static %}

{% block content %}
<div class="container py-4">

  <h2 class="mb-3">Program Requirements</h2>

  <form method="get" class="row g-3 align-items-end">
    <div class="col-md-4">
      <label class="form-label">Program Name *</label>
      <select id="program-select" name="program" class="form-select">
        <option value="">-- Select Program --</option>
        {% for name in program_names %}
          <option value="{{ name.name }}" {% if name.name == selected_program_name %}selected{% endif %}>{{ name.name }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-4">
      <label class="form-label">Program Year Level *</label>
      <select id="level-select" name="level" class="form-select" disabled>
        <option value="">-- Select Year Level --</option>
      </select>
    </div>

    <div class="col-md-4">
      <button type="submit" name="search" value="1" class="btn btn-primary">Search</button>
    </div>
  </form>

  {% if submitted %}
    {% if not_found %}
      <!-- actually no need anymore, because a program must have a year level -->
      <div class="alert alert-warning mt-4">No such program exists.</div>
    {% else %}
      {% if not display_program_name or not display_level_name %}
        <!-- do nothing -->
      {% else %}
        <p class="text-muted mb-4">
                Program: <strong>{{ display_program_name }}</strong> 
                Level: <strong>{{ display_level_name }}</strong>
                <button type="button"
                  class="btn btn-sm btn-primary ms-2"
                  id="btn-open-add"
                  data-bs-toggle="modal"
                  data-bs-target="#addCourseModal">
                  Add
                </button>
        </p>  

        <div class="table-wrapper table-responsive mt-4">
            <table class="table table-bordered table-striped table-hover text-center">
            <thead>
                <tr>
                <th>Code</th>
                <th>Number</th>
                <th>Action</th>
                </tr>
            </thead>
            <tbody>
              {% for c in courses %}
                <tr>
                  <td>{{ c.code.name | default:"None" }}</td>
                  <td>{{ c.number.name | default:"None" }}</td>
                  <td>
                    <button
                      type="button"                       
                      class="btn btn-outline-danger btn-sm js-open-delete"
                      data-code="{{ c.code.name }}"
                      data-number="{{ c.number.name }}">
                      Delete
                    </button>
                  </td>
                </tr>
              {% empty %}
                <tr><td colspan="3">No courses found.</td></tr>
              {% endfor %}
            </tbody>
            </table>
        </div>
      {% endif %}
    {% endif %}
  {% endif %}

  <div class="modal fade" id="confirmDetach" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Remove Course from Program</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
  
        <form method="post" action="{% url 'scheduler:requirements_detach_course' %}">
          {% csrf_token %}
          <div class="modal-body">
            <p>Are you sure you want to remove this course from the program?</p>
            <p class="mb-0"><strong>Course:</strong> <strong><span id="confirmCourseText"></span></strong></p>
          </div>
          <div class="modal-footer">
            <!-- hidden fields filled by JS -->
            <input type="hidden" name="program_name" id="hidProgram" value="{{ display_program_name }}">
            <input type="hidden" name="level_name"   id="hidLevel"   value="{{ display_level_name }}">
            <input type="hidden" name="code_name"    id="hidCode">
            <input type="hidden" name="number_name"  id="hidNumber">
  
            <button type="submit" class="btn btn-danger">Delete</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div class="modal fade" id="addCourseModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Add Course to Program</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
  
        <form method="post" action="{% url 'scheduler:requirements_attach_course' %}">
          {% csrf_token %}
          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label">Course Code *</label>
              <select id="add-code" name="code_name" class="form-select" required>
                <option value="">-- Select Code --</option>
                {% for code in course_codes %}
                  <option value="{{ code.name }}">{{ code.name }}</option>
                {% endfor %}
              </select>
            </div>
  
            <div class="mb-3">
              <label class="form-label">Course Number *</label>
              <select id="add-number" name="number_name" class="form-select" required disabled>
                <option value="">-- Select Number --</option>
              </select>
            </div>
  
            <input type="hidden" name="program_name" value="{{ display_program_name }}">
            <input type="hidden" name="level_name"   value="{{ display_level_name }}">
          </div>
  
          <div class="modal-footer">
            <button type="submit" class="btn btn-primary" id="add-save">Save</button>
          </div>
        </form>
      </div>
    </div>
  </div>

</div>
{% endblock %}

{% block js %}
<script>
  (function() {
    const programSel = document.getElementById('program-select');
    const levelSel   = document.getElementById('level-select');
  
    function resetLevels() {
      levelSel.innerHTML = '<option value="">-- Select Year Level --</option>';
    }
  
    async function loadLevelsFor(programName) {
      resetLevels();
      if (!programName) {
        levelSel.disabled = true;
        return;
      }
      try {
        const resp = await fetch("{% url 'scheduler:ajax_levels_for_program' %}?program=" + encodeURIComponent(programName));
        const data = await resp.json();
        for (const lvl of data.levels) {
          const opt = document.createElement('option');
          opt.value = opt.textContent = lvl;
          levelSel.appendChild(opt);
        }
        levelSel.disabled = data.levels.length === 0; // stays disabled if none, actually no need, becasue each program must have a year level
      } catch (e) {
        // fallback: keep it disabled on error
        levelSel.disabled = true;
      }
    }
  
    // On change, (re)populate year levels for the chosen program
    programSel.addEventListener('change', (e) => loadLevelsFor(e.target.value));
  })();
</script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const modalEl   = document.getElementById('confirmDetach');
    const modal     = new bootstrap.Modal(modalEl);
    const txt       = document.getElementById('confirmCourseText');
    const hidCode   = document.getElementById('hidCode');
    const hidNumber = document.getElementById('hidNumber');

    document.querySelectorAll('.js-open-delete').forEach(btn => {
      btn.addEventListener('click', () => {
        const code = btn.dataset.code;
        const num  = btn.dataset.number;

        txt.textContent     = `${code} ${num}`;
        hidCode.value       = code;
        hidNumber.value     = num;

        modal.show();
      });
    });
  });
</script>
<script>
  (function() {
    const codeSel   = document.getElementById('add-code');
    const numSel    = document.getElementById('add-number');

    function resetNums() {
      numSel.innerHTML = '<option value="">-- Select Number --</option>';
      numSel.disabled = true;
    }

    function resetAddForm() {
      // clear BOTH dropdowns every time the modal opens
      if (codeSel) codeSel.selectedIndex = 0;   // <-- clear Course Code
      resetNums();                               // <-- clears & disables Number
    }

    async function loadNumbersFor(codeName) {
      resetNums();
      if (!codeName) return;
      try {
        const resp = await fetch("{% url 'scheduler:ajax_numbers_for_code' %}?code=" + encodeURIComponent(codeName));
        const data = await resp.json();
        for (const n of data.numbers) {
          const opt = document.createElement('option');
          opt.value = opt.textContent = n;
          numSel.appendChild(opt);
        }
        numSel.disabled = data.numbers.length === 0;
      } catch (e) {
        numSel.disabled = true;
      }
    }

    codeSel?.addEventListener('change', (e) => {
      loadNumbersFor(e.target.value);
    });

    // In case the modal is reopened, always reset
    document.getElementById('addCourseModal')?.addEventListener('show.bs.modal', resetAddForm);
  })();
</script>
{% endblock %}
