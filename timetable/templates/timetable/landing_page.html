{% extends 'timetable/base.html' %}
{% load static %}
{% block content %}
{% load custom_filters %}
<!-- 
- edit navbar reorganize into admin folder
- talk to brandon about fixtures
- create a course
- pre sort courses by highest year
- figure out way to clone db to new year ( check w brandon ) (TA app already does that )
-->

<!-- styles for timetable grid  -->
<style>
.timetable-grid .course-cell { position: relative; }
.course-item{
  position: absolute;
  right: 0;          /* anchor to the right edge */
  left: auto;        /* ignore any left positioning */
  border-radius: .4rem;
  padding: .25rem .35rem;
  font-size: .8rem;
  line-height: 1.1;
  color: #111;
  box-shadow: 0 1px 2px rgba(0,0,0,.08);
  overflow: hidden;
}
</style>

<!-- libray for the filters -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<div class="container-fluid py-4 px-4">
  <div class="row gy-4 flex-column">
    <!-- ───────── Mini Year/Term Filters ───────── -->
    <form method="get" action="{% url 'scheduler:landing_page' %}" class="row g-3 align-items-end mb-3">
      <div class="col-md-3">
        <label class="form-label">Academic Year *</label>
        <select id="year-select" name="year" class="form-select">
          <option value="">-- Select Academic Year --</option>
          {% for y in dropdown_years %}
            <option value="{{ y }}" {% if y == selected_year %}selected{% endif %}>{{ y }}</option>
          {% endfor %}
        </select>
      </div>
    
      <div class="col-md-5">
        <label class="form-label">Term *</label>
        <select id="term-select"
                name="term"
                class="form-select"
                multiple
                {% if not selected_year %}disabled{% endif %}>
          {% if selected_year %}
            {% for t in available_terms_for_year %}
              <option value="{{ t }}" {% if t in selected_terms %}selected{% endif %}>{{ t }}</option>
            {% endfor %}
          {% endif %}
        </select>
      </div>
      
      <div class="col-md-2">
        <button type="submit" class="btn btn-primary" name="search" value="1">Search</button>
      </div>

      <!--──────── Filters block ────────-->
      <div class="col-12">
        <!-- Filters Form -->
        <div class="card shadow-sm p-3 rounded-2 filters-container flex-row justify-content-between">
          <h4 class="fw-semibold mt-4" id="filter-title">Filters: </h4>

          <!-- By Course -->
          <div class="mb-3">
            <div class="fw-semibold mb-1">By Course: </div>
          </div>
          
          <!-- By Program -->
          <div class="mb-3">
            <div class="fw-semibold mb-1">By Program: </div>
            <div class="row g-2">
              <!-- Program Name (enabled only if at least one term is selected) -->
              <div class="col-md-6">
                <label class="form-label">Name</label>
                <select id="prog-name" name="pname" class="form-select"
                        {% if not selected_terms %}disabled{% endif %}>
                  <option value="">-- Select Name --</option>
                  {% for n in program_names %}
                    <option value="{{ n.name }}" {% if n.name == selected_pname %}selected{% endif %}>{{ n.name }}</option>
                  {% endfor %}
                </select>
              </div>

              <!-- Program Year Level (enabled after Name) -->
              <div class="col-md-6">
                <label class="form-label">Year Level</label>
                <select id="prog-level" name="plevel" class="form-select"
                        {% if not selected_pname %}disabled{% endif %}>
                  <option value="">-- Select Year Level --</option>
                  {% if selected_pname %}
                    {% for lvl in available_levels_for_name %}
                      <option value="{{ lvl }}" {% if lvl == selected_plevel %}selected{% endif %}>{{ lvl }}</option>
                    {% endfor %}
                  {% endif %}
                </select>
              </div>
            </div>
          </div>

        </div>
      </div>

    </form>

    <!--──────── TIMETABLE ────────-->
    <div class="col-12">
      <div class="card shadow-sm p-4 rounded-3">
        <h4 class="fw-semibold text-center mb-4">Course Timetable</h4>
        <div class="table-responsive rounded-corner-table">
          
          <!-- Timetable Grid -->
          <table class="timetable-grid">
            <thead>
              <tr>
                <th class="time-col"></th>
                <th>Mon</th>
                <th>Tues</th>
                <th>Wed</th>
                <th>Thurs</th>
                <th>Fri</th>
              </tr>
            </thead>


            <!-- For each day go through hour list and insert course if it has matching day and hour-->
            <tbody>
              {% if submitted and not courses %}
              <div class="error-courses-container">

                <h3 class="error-no-courses">No Courses Found</h3>
              </div>
              {% endif %}

              {% for hour in hour_list %}
              <tr>
                <td class="time-col">{{ hour }}:00</td>
                {% for day in day_list %}

                <td class="course-cell">
                  {% for course in courses %}
                    {% with course|get_day:day as data %}
                      {% if day in course.day_names %}
                        {% if course.start_time and course.start_time.name|slice:":2" == hour %}
                          <div class="course-item {% if data.overlap %}overlap{% endif %}"
                               data-height="{{ course.pixel_height }}"
                               data-bg="{{ course.code.color }}"
                               data-top="{{ course.offset_top }}"
                               data-width="{{ data.width|default:'100' }}"
                               data-left="{{ data.left|default:'0' }}"
                               data-z="{{ data.z|default:'1' }}"
                               data-code="{{ course.code.name|default:'None' }}"
                               data-number="{{ course.number.name|default:'None' }}"
                               data-start="{{ course.start_time.name|default:'None' }}"
                               data-end="{{ course.end_time.name|default:'None' }}"
                               data-day="{{ course.day_names|join:',' }}"
                               data-section="{{ course.section.name|default:'None' }}"
                               data-academic-year="{{ course.academic_year.name|default:'None' }}"
                               data-term="{{ course.term.name|default:'None' }}">
                            <strong>{{ course.code.name|default:'None' }} {{ course.number.name|default:'None' }} {{ course.section.name|default:'None' }}</strong>
                          </div>
                        {% endif %}
                      {% endif %}
                    {% endwith %}
                  {% endfor %}
                </td>
                
                
                {% endfor %}
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
    
    <!--──────── COURSES WITHOUT SCHEDULED TIMES ────────-->
    {% if invalid_courses %}
    <div class="col-12 mt-4">
      <div class="card shadow-sm p-4 rounded-3">
        <h4 class="fw-semibold text-center mb-3">Courses Without Scheduled Times</h4>
        <table class="table table-bordered table-striped table-hover text-center">
          <thead>
              <tr>
                  <th>ID</th>
                  <th>Code</th>
                  <th>Number</th>
                  <th>Section</th>
                  <th>Year</th>
                  <th>Term</th>
              </tr>
          </thead>
          <tbody>
              {% for course in invalid_courses %}
              <tr>
                  <td>{{ course.id }}</td>
                  <td>{{ course.code }}</td>
                  <td>{{ course.number }}</td>
                  <td>{{ course.section }}</td>
                  <td>{{ course.academic_year }}</td>
                  <td>{{ course.term }}</td>
              </tr>
              {% empty %}
              <tr>
                  <td colspan="9">No courses found.</td>
              </tr>
              {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    {% endif %}
  </div>
</div>

<!-- setup for timetable grid outline -->
<script>
  (function () {
    const items = document.querySelectorAll('.course-item');
  
    // helper: turn #RRGGBB into rgba(...) with a given alpha
    function hexToRgba(hex, a) {
      const m = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex || "");
      if (!m) return hex; // fallback to whatever was passed
      const r = parseInt(m[1], 16), g = parseInt(m[2], 16), b = parseInt(m[3], 16);
      return `rgba(${r}, ${g}, ${b}, ${a})`;
    }
  
    items.forEach(el => {
      const h = el.dataset.height,
            t = el.dataset.top,
            w = el.dataset.width,
            bg = el.dataset.bg,
            z = el.dataset.z;
  
      if (h) el.style.height = h + 'px';
      if (t) el.style.marginTop = t + 'px';
      if (w) el.style.width = w + '%';
  
      // RIGHT-ALIGN: ignore left; optionally set right offset if you ever pass one
      // if needed later: el.style.right = (el.dataset.right || 0) + '%';
  
      // TRANSPARENCY + colored stripe
      if (bg) {
        el.style.backgroundColor = hexToRgba(bg, 0.35);     // translucent fill
        el.style.borderLeft = `4px solid ${bg}`;            // solid accent bar
      }
      if (z) el.style.zIndex = z;
    });
  })();
</script>
<script>
  (function() {
    const termsUrl = "{% url 'scheduler:ajax_terms_for_year' %}";
    const yearSel  = document.getElementById('year-select');
    const termSel  = document.getElementById('term-select');

    // Helper: initialize Select2 on #term-select
    function initSelect2() {
      // destroy if already initialized
      if ($(termSel).hasClass('select2-hidden-accessible')) {
        $(termSel).select2('destroy');
      }
      $(termSel).select2({
        placeholder: "Select Terms",
        width: '100%',
        allowClear: true
      });
    }

    // Initial boot (page load): if a year is preselected, init Select2 with those options
    initSelect2();

    // If the select is disabled at load, Select2 mirrors that; nothing else to do

    // When Academic Year changes: fetch terms, repopulate, enable + re-init Select2
    async function loadTermsFor(year) {
      // clear options
      termSel.innerHTML = "";
      // disable while loading
      termSel.disabled = true;
      if ($(termSel).hasClass('select2-hidden-accessible')) {
        $(termSel).val(null).trigger('change');
      }

      if (!year) { initSelect2(); return; }

      try {
        const resp = await fetch(termsUrl + "?year=" + encodeURIComponent(year));
        const data = await resp.json();

        // build options
        data.terms.forEach(t => {
          const opt = document.createElement('option');
          opt.value = t; opt.textContent = t;
          termSel.appendChild(opt);
        });

        // enable + re-init
        termSel.disabled = (data.terms.length === 0);
        initSelect2();

        // nothing preselected after changing year
        $(termSel).val(null).trigger('change');

      } catch (e) {
        // on error keep disabled and empty
        termSel.disabled = true;
        initSelect2();
      }
    }

    yearSel?.addEventListener('change', (e) => loadTermsFor(e.target.value));
  })();
</script>
<script>
  (function(){
    const termSel   = $('#term-select'); 
    const nameSel  = document.getElementById('prog-name');
    const levelSel = document.getElementById('prog-level');

    function disableProgramFilters() {
      // reset name
      if (nameSel) {
        nameSel.value = "";
        nameSel.disabled = true;
      }
      // reset level
      if (levelSel) {
        levelSel.innerHTML = '<option value="">-- Select Year Level --</option>';
        levelSel.disabled = true;
      }
    }

    function enableProgramName() {
      if (nameSel) {
        nameSel.disabled = false;
      }
      // level still depends on name selection — we keep it as-is here
      if (nameSel && !nameSel.value) {
        levelSel.innerHTML = '<option value="">-- Select Year Level --</option>';
        levelSel.disabled = true;
      }
    }

     function updateFromTerms() {
      const vals = termSel.val();          // array or null
      const hasTerms = Array.isArray(vals) && vals.length > 0;
      if (hasTerms) {
        enableProgramName();
      } else {
        disableProgramFilters();
      }
    }

    termSel.on('change', updateFromTerms);

    function resetLevels() {
      levelSel.innerHTML = '<option value="">-- Select Year Level --</option>';
      levelSel.disabled = true;
    }

    async function loadLevelsFor(programName) {
      resetLevels();
      if (!programName) return;

      try {
        const resp = await fetch("{% url 'scheduler:ajax_levels_for_program' %}?program=" + encodeURIComponent(programName));
        const data = await resp.json();
        data.levels.forEach(l => {
          const opt = document.createElement('option');
          opt.value = opt.textContent = l;
          levelSel.appendChild(opt);
        });
        levelSel.disabled = data.levels.length === 0;
      } catch (e) {
        resetLevels();
      }
    }

    nameSel?.addEventListener('change', e => loadLevelsFor(e.target.value));
  })();
</script>
{% endblock %}
