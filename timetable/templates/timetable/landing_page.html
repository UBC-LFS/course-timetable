{% extends 'timetable/base.html' %}
{% load static %}
{% block content %}
{% load custom_filters %}

<!-- styles for timetable grid  -->
<style>
.timetable-grid .course-cell { position: relative; }
.course-item{
  position: absolute;
  right: 0;          /* anchor to the right edge */
  left: auto;        /* ignore any left positioning */
  border-radius: .4rem;
  padding: .25rem .35rem;
  font-size: .8rem;
  line-height: 1.1;
  color: #111;
  box-shadow: 0 1px 2px rgba(0,0,0,.08);
  overflow: hidden;
}
</style>

<!-- libraries for the filters -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<div class="container-fluid py-4 px-4">
  <div class="row gy-4 flex-column">
    <!-- ───────── Mini Year/Term Filters ───────── -->
    <form method="get" action="{% url 'scheduler:landing_page' %}" class="row g-3 align-items-end mb-3">
      <div class="col-md-3">
        <label class="form-label">Academic Year *</label>
        <select id="year-select" name="year" class="form-select">
          <option value="">-- Select Academic Year --</option>
          {% for y in dropdown_years %}
            <option value="{{ y }}" {% if y == selected_year %}selected{% endif %}>{{ y }}</option>
          {% endfor %}
        </select>
      </div>
    
      <div class="col-md-5">
        <label class="form-label">Term *</label>
        <select id="term-select"
                name="term"
                class="form-select"
                multiple
                {% if not selected_year or not available_terms_for_year %}disabled{% endif %}>
          {% if selected_year %}
            {% for t in available_terms_for_year %}
              <option value="{{ t }}" {% if t in selected_terms %}selected{% endif %}>{{ t }}</option>
            {% endfor %}
          {% endif %}
        </select>
      </div>
      
      <div class="col-md-2">
        <button type="submit" class="btn btn-primary" name="search" value="1">Search</button>
      </div>

      <!--──────── Filters block ────────-->
      <div class="col-12">
        <!-- Filters Form -->
        <div class="card shadow-sm p-3 rounded-2 filters-container d-flex flex-column">
          <h4 class="fw-semibold mt-4" id="filter-title">Filters: </h4>

          <!-- By Course -->
          <div class="mb-3">
            <div class="fw-semibold mb-1">By Course: </div>
          
            <!-- Hidden field that carries all course lines as JSON -->
            <input type="hidden" id="courseFiltersJson" name="course_filters_json" value="{{ course_filters_json|default:'' }}"/>
          
            <div id="by-course-lines" class="d-flex flex-column gap-2"></div>
          
            <!-- Template for a line (cloned by JS). -->
            <template id="by-course-template">
              <div class="row g-2 align-items-end by-course-row">
                <div class="col-md-6">
                  <label class="form-label">Code</label>
                  <select class="form-select js-course-code" data-line="">
                    <option value="">-- Select Code --</option>
                    {% for c in codes %}
                      <option value="{{ c.name }}">{{ c.name }}</option>
                    {% endfor %}
                  </select>
                </div>

                <div class="col-md-5">
                  <label class="form-label">Number</label>
                  <select class="form-select js-course-number" data-line="" multiple disabled></select>
                </div>

                <div class="col-md-1 d-flex gap-2">
                  <button type="button" class="btn btn-outline-primary btn-sm js-add-line"  title="Add">+</button>
                  <button type="button" class="btn btn-outline-danger  btn-sm js-remove-line" title="Remove">−</button>
                </div>

              </div>
            </template>
          </div>
          
          <!-- By Program -->
          <div class="mb-3">
            <div class="fw-semibold mb-1">By Program: </div>
            <div class="row g-2">
              <!-- Program Name -->
              <div class="col-md-6">
                <label class="form-label">Name</label>
                <select id="prog-name" name="pname" class="form-select"
                        {% if not selected_terms %}disabled{% endif %}>
                  <option value="">-- Select Name --</option>
                  {% for n in program_names %}
                    <option value="{{ n.name }}" {% if n.name == selected_pname %}selected{% endif %}>{{ n.name }}</option>
                  {% endfor %}
                </select>
              </div>

              <!-- Program Year Level -->
              <div class="col-md-6">
                <label class="form-label">Year Level</label>
                <select id="prog-level" name="plevel" class="form-select"
                        {% if not selected_pname or not available_levels_for_name %}disabled{% endif %}>
                  <option value="">-- Select Year Level --</option>
                  {% if selected_pname %}
                    {% for lvl in available_levels_for_name %}
                      <option value="{{ lvl }}" {% if lvl == selected_plevel %}selected{% endif %}>{{ lvl }}</option>
                    {% endfor %}
                  {% endif %}
                </select>
              </div>
            </div>
          </div>

        </div>
      </div>

    </form>

    {% if not selected_year or not selected_terms %}
      <!-- do nothing -->
    {% else %}
      <!--──────── TIMETABLE ────────-->
      <div class="col-12">
        <div class="card shadow-sm p-4 rounded-3">
          <h4 class="fw-semibold text-center mb-4">Course Timetable</h4>
          <div class="table-responsive rounded-corner-table">
            
            <!-- Timetable Grid -->
            <table class="timetable-grid">
              <thead>
                <tr>
                  <th class="time-col"></th>
                  <th>Mon</th>
                  <th>Tues</th>
                  <th>Wed</th>
                  <th>Thurs</th>
                  <th>Fri</th>
                </tr>
              </thead>


              <!-- For each day go through hour list and insert course if it has matching day and hour-->
              <tbody>
                {% if submitted and not courses %}
                <div class="error-courses-container">

                  <h3 class="error-no-courses">No Courses Found</h3>
                </div>
                {% endif %}

                {% for hour in hour_list %}
                <tr>
                  <td class="time-col">{{ hour }}:00</td>
                  {% for day in day_list %}

                  <td class="course-cell">
                    {% for course in courses %}
                      {% with course|get_day:day as data %}
                        {% if day in course.day_names %}
                          {% if course.start_time and course.start_time.name|slice:":2" == hour %}
                            <div class="course-item {% if data.overlap %}overlap{% endif %}"
                                data-height="{{ course.pixel_height }}"
                                data-bg="{{ course.code.color }}"
                                data-top="{{ course.offset_top }}"
                                data-width="{{ data.width|default:'100' }}"
                                data-left="{{ data.left|default:'0' }}"
                                data-z="{{ data.z|default:'1' }}"
                                data-code="{{ course.code.name|default:'None' }}"
                                data-number="{{ course.number.name|default:'None' }}"
                                data-start="{{ course.start_time.name|default:'None' }}"
                                data-end="{{ course.end_time.name|default:'None' }}"
                                data-day="{{ course.day_names|join:',' }}"
                                data-section="{{ course.section.name|default:'None' }}"
                                data-academic-year="{{ course.academic_year.name|default:'None' }}"
                                data-term="{{ course.term.name|default:'None' }}">
                              <strong>{{ course.code.name|default:'None' }} {{ course.number.name|default:'None' }} {{ course.section.name|default:'None' }}</strong>
                            </div>
                          {% endif %}
                        {% endif %}
                      {% endwith %}
                    {% endfor %}
                  </td>
                  
                  {% endfor %}
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
      
      <!--──────── COURSES WITHOUT SCHEDULED TIMES ────────-->
      {% if invalid_courses %}
        <div class="col-12 mt-4">
          <div class="card shadow-sm p-4 rounded-3">
            <h4 class="fw-semibold text-center mb-3">Courses Without Scheduled Times</h4>
            <table class="table table-bordered table-striped table-hover text-center">
              <thead>
                  <tr>
                      <th>Code</th>
                      <th>Number</th>
                      <th>Section</th>
                      <th>Academic Year</th>
                      <th>Term</th>
                  </tr>
              </thead>
              <tbody>
                  {% for course in invalid_courses %}
                  <tr>
                      <td>{{ course.code }}</td>
                      <td>{{ course.number }}</td>
                      <td>{{ course.section }}</td>
                      <td>{{ course.academic_year }}</td>
                      <td>{{ course.term }}</td>
                  </tr>
                  {% empty %}
                  {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      {% endif %}
    {% endif %}
  
  </div>
</div>

<!-- setup for timetable grid outline -->
<script>
  (function () {
    const items = document.querySelectorAll('.course-item');
  
    // helper: turn #RRGGBB into rgba(...) with a given alpha
    function hexToRgba(hex, a) {
      const m = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex || "");
      if (!m) return hex; // fallback to whatever was passed
      const r = parseInt(m[1], 16), g = parseInt(m[2], 16), b = parseInt(m[3], 16);
      return `rgba(${r}, ${g}, ${b}, ${a})`;
    }
  
    items.forEach(el => {
      const h = el.dataset.height,
            t = el.dataset.top,
            w = el.dataset.width,
            bg = el.dataset.bg,
            z = el.dataset.z;
  
      if (h) el.style.height = h + 'px';
      if (t) el.style.marginTop = t + 'px';
      if (w) el.style.width = w + '%';
  
      // TRANSPARENCY + colored stripe
      if (bg) {
        el.style.backgroundColor = hexToRgba(bg, 0.35);     // translucent fill
        el.style.borderLeft = `4px solid ${bg}`;            // solid accent bar
      }
      if (z) el.style.zIndex = z;
    });
  })();
</script>
<script>
  (function() {
    const termsUrl = "{% url 'scheduler:ajax_terms_for_year' %}";
    const yearSel  = document.getElementById('year-select');
    const termSel  = document.getElementById('term-select');

    // helper: initialize Select2 on #term-select
    function initSelect2() {
      // destroy if already initialized
      if ($(termSel).hasClass('select2-hidden-accessible')) {
        $(termSel).select2('destroy');
      }
      $(termSel).select2({
        placeholder: "Select Terms",
        width: '100%',
        allowClear: true
      });
    }

    // Initial boot (page load): if a year is preselected, init Select2 with those options
    initSelect2();

    // If the select is disabled at load, Select2 mirrors that; nothing else to do

    // When Academic Year changes: fetch terms, repopulate, enable + re-init Select2
    async function loadTermsFor(year) {
      // clear options
      termSel.innerHTML = "";
      // disable while loading
      termSel.disabled = true;
      if ($(termSel).hasClass('select2-hidden-accessible')) {
        $(termSel).val(null).trigger('change');
      }

      if (!year) { initSelect2(); return; }

      try {
        const resp = await fetch(termsUrl + "?year=" + encodeURIComponent(year));
        const data = await resp.json();

        // build options
        data.terms.forEach(t => {
          const opt = document.createElement('option');
          opt.value = t; opt.textContent = t;
          termSel.appendChild(opt);
        });

        // enable + re-init
        termSel.disabled = (data.terms.length === 0);
        initSelect2();

        // nothing preselected after changing year
        $(termSel).val(null).trigger('change');

      } catch (e) {
        // on error keep disabled and empty
        termSel.disabled = true;
        initSelect2();
      }
    }

    yearSel?.addEventListener('change', (e) => loadTermsFor(e.target.value));
  })();
</script>
<script>
  (function(){
    const termSel   = $('#term-select');
    const linesHost = document.getElementById('by-course-lines');
    const tpl       = document.getElementById('by-course-template');
    const hidden    = document.getElementById('courseFiltersJson');
    const urlNums   = "{% url 'scheduler:ajax_numbers_for_code' %}";
    const preloadMap = JSON.parse('{{ numbers_by_code_json|default:"{}"|escapejs }}');
  
    let nextLineId = 0;
  
    function hasTerms() {
      const v = termSel.val();
      return Array.isArray(v) && v.length > 0;
    }
  
    function initNumSelect2(selectEl) {
      const $el = $(selectEl);
      if ($el.hasClass('select2-hidden-accessible')) $el.select2('destroy');
      $el.select2({ placeholder: "Select Numbers", width: '100%', allowClear: true });
    }
  
    async function loadNumbersInto(selectEl, code) {
      // clear + disable while loading
      selectEl.innerHTML = "";
      selectEl.disabled  = true;
      initNumSelect2(selectEl);
      if (!code) return;
  
      try {
        const resp = await fetch(urlNums + "?code=" + encodeURIComponent(code));
        const data = await resp.json();
        data.numbers.forEach(n => {
          const opt = document.createElement('option');
          opt.value = n; 
          opt.textContent = n;
          selectEl.appendChild(opt);
        });
        selectEl.disabled = (data.numbers.length === 0);
        initNumSelect2(selectEl);
      } catch(e) {
        selectEl.disabled = true;
        initNumSelect2(selectEl);
      }
    }
  
    function setRowEnabled(row, enabled) {
      const code   = row.querySelector('.js-course-code');
      const number = row.querySelector('.js-course-number');
      const addBtn = row.querySelector('.js-add-line');
      const rmBtn  = row.querySelector('.js-remove-line');
  
      code.disabled   = !enabled;
      addBtn.disabled = !enabled;
  
      // number depends on code; if disabling the row, also clear/disable number
      if (!enabled) {
        number.innerHTML = "";
        number.disabled  = true;
        $(number).val(null).trigger('change');
        initNumSelect2(number);
      }
      if (row === linesHost.firstElementChild) {
        rmBtn.classList.add('d-none');
      } else {
        rmBtn.classList.remove('d-none');
        addBtn.classList.add('d-none')
      }
    }

    function applyTermEnablement() {
      const enabled = hasTerms();
      if (!enabled) {
        // hard reset to canonical state: one disabled row, no data
        linesHost.innerHTML = "";
        const row = makeRow(null);
        linesHost.appendChild(row);
        setRowEnabled(row, false);
        hidden.value = "";
        return;
      }
      [...linesHost.children].forEach(row => setRowEnabled(row, enabled));
    }
    
    function makeRow(prefill) {
      const node = tpl.content.firstElementChild.cloneNode(true);
      const lineId = nextLineId++;
      const code   = node.querySelector('.js-course-code');
      const number = node.querySelector('.js-course-number');
      code.dataset.line = number.dataset.line = String(lineId);
  
      // prefill
      if (prefill && prefill.code) {
        code.value = prefill.code;
      }
      initNumSelect2(number);
  
      // listeners
      code.addEventListener('change', () => {
        const pre = preloadMap[code.value];
        if (pre && pre.length) {
          number.innerHTML = "";
          pre.forEach(n => {
            const opt = document.createElement('option');
            opt.value = n; 
            opt.textContent = n;
            number.appendChild(opt);
          });
          number.disabled = false;
          initNumSelect2(number);
        } else {
          // fallback
          loadNumbersInto(number, code.value); 
        }
      });

      node.querySelector('.js-add-line').addEventListener('click', () => {
        linesHost.appendChild(makeRow(null));
        applyTermEnablement();    // apply enable/disable based on current terms
      });

      node.querySelector('.js-remove-line').addEventListener('click', () => {
        node.remove();
        // if no lines left, ensure at least one initial line exists
        if (!linesHost.children.length) linesHost.appendChild(makeRow(null));
        applyTermEnablement();
      });

      // if prefill includes numbers, load and select after load
      if (prefill && prefill.code) {
        const pre = preloadMap[prefill.code];
        if (pre && pre.length) {
          number.innerHTML = "";
          pre.forEach(n => {
            const opt = document.createElement('option');
            opt.value = n; 
            opt.textContent = n;
            number.appendChild(opt);
          });
          number.disabled = false;
          initNumSelect2(number);
          if (prefill.numbers && prefill.numbers.length) {
            $(number).val(prefill.numbers).trigger('change');
          }
        }
        else {
          // fallback
          loadNumbersInto(number, prefill.code).then(() => {
            if (prefill.numbers && prefill.numbers.length) {
              $(number).val(prefill.numbers).trigger('change');
            }
          });
        }
      }

      return node;
    }
  
    // Serialize lines → hidden input before submit
    function serializeLines() {
      if (!hasTerms()) { hidden.value = ""; return; }
      const result = [];
      [...linesHost.children].forEach(row => {
        const code   = row.querySelector('.js-course-code').value.trim();
        const number = row.querySelector('.js-course-number');
        const nums   = $(number).val() || [];
        if (code || (nums && nums.length)) {
          result.push({ code, numbers: nums });
        }
      });
      hidden.value = JSON.stringify(result);
    }

    // 1) Build initial row
    linesHost.appendChild(makeRow(null));
  
    // 2) If server returned prior selections, rebuild them — but ONLY when Term has values
    try {
      const pre = hidden.value ? JSON.parse(hidden.value) : [];
      if (hasTerms() &&Array.isArray(pre) && pre.length) {
        // replace the single empty row with prefilled rows
        linesHost.innerHTML = "";
        pre.forEach((item, idx) => linesHost.appendChild(makeRow({ code: item.code, numbers: item.numbers || [] })));
      }
    } catch(e) { 
      // ignore 
    }
  
    // 3) Tie enable/disable to Term changes
    termSel.on('change', applyTermEnablement);
    applyTermEnablement();
  
    // 4) On form submit: serialize
    const form = document.querySelector('form[action$="{% url "scheduler:landing_page" %}"]');
    form.addEventListener('submit', serializeLines);
  })();
</script>
<script>
  (function(){
    const termSel   = $('#term-select'); 
    const nameSel  = document.getElementById('prog-name');
    const levelSel = document.getElementById('prog-level');

    function disableProgramFilters() {
      // reset name
      if (nameSel) {
        nameSel.value = "";
        nameSel.disabled = true;
      }
      // reset level
      if (levelSel) {
        levelSel.innerHTML = '<option value="">-- Select Year Level --</option>';
        levelSel.disabled = true;
      }
    }

    function enableProgramName() {
      if (nameSel) {
        nameSel.disabled = false;
      }
      // level still depends on name selection — we keep it as-is here
      if (nameSel && !nameSel.value) {
        levelSel.innerHTML = '<option value="">-- Select Year Level --</option>';
        levelSel.disabled = true;
      }
    }

     function updateFromTerms() {
      const vals = termSel.val();
      const hasTerms = Array.isArray(vals) && vals.length > 0;
      if (hasTerms) {
        enableProgramName();
      } else {
        disableProgramFilters();
      }
    }

    termSel.on('change', updateFromTerms);

    function resetLevels() {
      levelSel.innerHTML = '<option value="">-- Select Year Level --</option>';
      levelSel.disabled = true;
    }

    async function loadLevelsFor(programName) {
      resetLevels();
      if (!programName) return;

      try {
        const resp = await fetch("{% url 'scheduler:ajax_levels_for_program' %}?program=" + encodeURIComponent(programName));
        const data = await resp.json();
        data.levels.forEach(l => {
          const opt = document.createElement('option');
          opt.value = opt.textContent = l;
          levelSel.appendChild(opt);
        });
        levelSel.disabled = data.levels.length === 0;
      } catch (e) {
        resetLevels();
      }
    }

    nameSel?.addEventListener('change', e => loadLevelsFor(e.target.value));
  })();
</script>
{% endblock %}
