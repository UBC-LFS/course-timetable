{% extends 'timetable/base.html' %}
{% load static %}
{% block content %}
{% load custom_filters %}
<!-- 
- edit navbar reorganize into admin folder
- talk to brandon about fixtures
- create a course
- pre sort courses by highest year
- figure out way to clone db to new year ( check w brandon ) (TA app already does that )
-->

<!-- page-specific styles for timetable -->
<style>
  .timetable-grid .course-cell { position: relative; }
  .course-item{
    position: absolute;
    border-radius: .4rem;
    padding: .25rem .35rem;
    font-size: .8rem;
    line-height: 1.1;
    color: #111;
    box-shadow: 0 1px 2px rgba(0,0,0,.08);
    overflow: hidden;
  }
</style>

<div class="container-fluid py-4 px-4">
  <div class="row gy-4 flex-column">
    
    <!--──────── FILTERS ────────-->
    <div class="col-12">
      <!-- Filters Form -->
      <form method="get" action="{% url 'scheduler:landing_page' %}"class="card shadow-sm p-3 rounded-2 filters-container flex-row justify-content-between">
        <h4 class="fw-semibold mt-4" id="filter-title">Filters</h4>

        <!-- Each section pulls from Views.py to populate the dropdowns -->
        <div class="mb-3 dropdown dropdown-select">
          <label class="form-label d-block">Code</label>
          <button class="btn btn-outline-secondary dropdown-toggle w-100 text-start" type="button" data-bs-toggle="dropdown" aria-expanded="false" id="dropdownButton" data-default="Code">
            Code
          </button>
          <ul class="dropdown-menu p-3" style="max-height: 200px; overflow-y: auto;">
            {% for course in codes %}
              <li>
                <label class="form-check-label d-block">
                  <input class="form-check-input me-1" type="checkbox" name="code[]" value="{{ course }}">
                  {{ course }}
                </label>
              </li>
            {% endfor %}
          </ul>
        </div>

        <!-- Each section pulls from Views.py to populate the dropdowns -->
        <div class="mb-3 dropdown dropdown-select">
          <label class="form-label d-block">Number</label>
          <button class="btn btn-outline-secondary dropdown-toggle w-100 text-start" type="button" data-bs-toggle="dropdown" aria-expanded="false" id="dropdownButton" data-default="Number">
            Number
          </button>
          <ul class="dropdown-menu p-3" style="max-height: 200px; overflow-y: auto;">
            {% for number in numbers %}
              <li>
                <label class="form-check-label d-block">
                  <input class="form-check-input me-1" type="checkbox" name="number[]" value="{{ number }}">
                  {{ number }}
                </label>
              </li>
            {% endfor %}
          </ul>
        </div>

        <!-- Each section pulls from Views.py to populate the dropdowns -->
        <div class="mb-3 dropdown dropdown-select">
          <label class="form-label d-block">Section</label>
          <button class="btn btn-outline-secondary dropdown-toggle w-100 text-start" type="button" data-bs-toggle="dropdown" aria-expanded="false" data-default="Section">
            Section
          </button>
          <ul class="dropdown-menu p-3" style="max-height: 200px; overflow-y: auto;">
            {% for section in sections %}
              <li>
                <label class="form-check-label d-block">
                  <input class="form-check-input me-1" type="checkbox" name="section[]" value="{{ section }}">
                  {{ section }}
                </label>
              </li>
            {% endfor %}
          </ul>
        </div>

        <!-- Each section pulls from Views.py to populate the dropdowns -->
        <div class="mb-3 dropdown dropdown-select">
          <label class="form-label d-block">Term</label>
          <button class="btn btn-outline-secondary dropdown-toggle w-100 text-start" type="button" data-bs-toggle="dropdown" aria-expanded="false" data-default="Term">
            Term
          </button>
          <ul class="dropdown-menu p-3" style="max-height: 200px; overflow-y: auto;">
            {% for term in terms %}
              <li>
                <label class="form-check-label d-block">
                  <input class="form-check-input me-1" type="checkbox" name="term[]" value="{{ term }}">
                  {{ term }}
                </label>
              </li>
            {% endfor %}
          </ul>
        </div>

        <!-- Each section pulls from Views.py to populate the dropdowns -->
        <div class="mb-3 dropdown dropdown-select">
          <label class="form-label d-block">Start time</label>
          <button class="btn btn-outline-secondary dropdown-toggle w-100 text-start" type="button" data-bs-toggle="dropdown" aria-expanded="false" data-default="Start">
            Start
          </button>
          <ul class="dropdown-menu p-3" style="max-height: 200px; overflow-y: auto;">
            {% for start in times %}
              <li>
                <label class="form-check-label d-block">
                  <input class="form-check-input me-1" type="checkbox" name="start[]" value="{{ start }}">
                  {{ start }}
                </label>
              </li>
            {% endfor %}
          </ul>
        </div>

        <!-- Each section pulls from Views.py to populate the dropdowns -->
        <div class="mb-3 dropdown dropdown-select">
          <label class="form-label d-block">End time</label>
          <button class="btn btn-outline-secondary dropdown-toggle w-100 text-start" type="button" data-bs-toggle="dropdown" aria-expanded="false" data-default="End">
            End
          </button>
          <ul class="dropdown-menu p-3" style="max-height: 200px; overflow-y: auto;">
            {% for end in times %}
              <li>
                <label class="form-check-label d-block">
                  <input class="form-check-input me-1" type="checkbox" name="end[]" value="{{ end }}">
                  {{ end }}
                </label>
              </li>
            {% endfor %}
          </ul>
        </div>

        <!-- Each section pulls from Views.py to populate the dropdowns -->
        <div class="mb-3 dropdown dropdown-select">
          <label class="form-label d-block">Days of the week</label>
          <button class="btn btn-outline-secondary dropdown-toggle w-100 text-start" type="button" data-bs-toggle="dropdown" aria-expanded="false" data-default="Select Days">
            Select Days
          </button>
          <ul class="dropdown-menu p-3" style="max-height: 200px; overflow-y: auto;">
            {% for day in days %}
              <li>
                <label class="form-check-label d-block">
                  <input class="form-check-input me-1" type="checkbox" name="day[]" value="{{ day }}">
                  {{ day }}
                </label>
              </li>
            {% endfor %}
          </ul>
        </div>

        <!-- Submit filters button-->
        <button type="submit" class="btn btn-primary w-10 mt-5" style="transform: translateY(-16px);">Apply filters</button>
      </form>
    </div>

    <!--──────── TIMETABLE ────────-->
    <div class="col-12">
      <div class="card shadow-sm p-4 rounded-3">
        <h4 class="fw-semibold text-center mb-4">Course Timetable</h4>
        <div class="table-responsive rounded-corner-table">
          
          <!-- Timetable Grid -->
          <table class="timetable-grid">
            <thead>
              <tr>
                <th class="time-col"></th>
                <th>Mon</th>
                <th>Tues</th>
                <th>Wed</th>
                <th>Thurs</th>
                <th>Fri</th>
              </tr>
            </thead>


            <!-- For each day go through hour list and insert course if it has matching day and hour-->
            <tbody>
              {% if submitted and not courses %}
              <div class="error-courses-container">

                <h3 class="error-no-courses">No Courses Found</h3>
              </div>
              {% endif %}

              {% for hour in hour_list %}
              <tr>
                <td class="time-col">{{ hour }}:00</td>
                {% for day in day_list %}

                <td class="course-cell">
                  {% for course in courses %}
                    {% with course|get_day:day as data %}
                      {% if course.day and day in course.day.name %}
                        {% if course.start_time and course.start_time.name|slice:":2" == hour %}
                          <div class="course-item {% if data.overlap %}overlap{% endif %}"
                               data-height="{{ course.pixel_height }}"
                               data-bg="{{ course.color }}"
                               data-top="{{ course.offset_top }}"
                               data-width="{{ data.width|default:'100' }}"
                               data-left="{{ data.left|default:'0' }}"
                               data-code="{{ course.code.name }}"
                               data-number="{{ course.number.name }}"
                               data-start="{{ course.start_time.name }}"
                               data-end="{{ course.end_time.name }}"
                               data-day="{{ course.day.name }}"
                               data-section="{{ course.section.name }}"
                               data-academic-year="{{ course.academic_year.name }}"
                               data-term="{{ course.term.name }}">
                            <strong>{{ course.code.name }} {{ course.number.name }} {{ course.section.name }} {{ course.academic_year.name }} {{ course.term.name }}</strong>
                          </div>
                        {% endif %}
                      {% endif %}
                    {% endwith %}
                  {% endfor %}
                </td>
                
                
                {% endfor %}
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
    
    <!--──────── COURSES WITHOUT SCHEDULED TIMES ────────-->
    {% if invalid_courses %}
    <div class="col-12 mt-4">
      <div class="card shadow-sm p-4 rounded-3">
        <h4 class="fw-semibold text-center mb-3">Courses Without Scheduled Times</h4>
        <ul class="list-group">
          {% for course in invalid_courses %}
          <li class="list-group-item">
            {{ course.code }} {{ course.number }} {{ course.section }} {{course.academic_year}} {{ course.term }}
          </li>
          {% endfor %}
        </ul>
      </div>
    </div>
    {% endif %}

  </div>
</div>

<script>
  (function () {
    const items = document.querySelectorAll('.course-item');
    items.forEach(el => {
      const h = el.dataset.height,
            t = el.dataset.top,
            w = el.dataset.width,
            l = el.dataset.left,
            bg = el.dataset.bg;

      if (h) el.style.height = h + 'px';
      if (t) el.style.marginTop = t + 'px';
      if (w) el.style.width = w + '%';
      if (l) el.style.left = l + '%';
      if (bg) el.style.backgroundColor = bg;
    });
  })();
</script>

{% endblock %}
