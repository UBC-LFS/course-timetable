{% extends 'timetable/base.html' %}
{% load static %}

{% block content %}

<!-- libraries for the filters -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<style>
    /* Collapse the page when there are no results yet */
    .view-courses-container.no-results { min-height: 0 !important; padding-bottom: 0 !important; }
    .view-courses-container.no-results .courses-navbar { margin-bottom: 0 !important; }
</style>

<div class="view-courses-container {% if not submitted %}no-results{% endif %}">
    <div class="courses-navbar">
            <form method="get" action="{% url 'scheduler:view_courses' %}" class="mb-3 row g-3 align-items-end">
                
                <div class="col-md-3">
                    <label class="form-label">Academic Year</label>
                    <select id="courses-year" name="year" class="form-select" multiple>
                        {% for y in years %}
                            <option value="{{ y }}" {% if y in year_query %}selected{% endif %}>{{ y }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class = "col-md-9">
                    <!-- in order to let Code input start from second line -->
                </div>

                <div class="col-md-2">
                    <label class="form-label">Code</label>
                    <input type="text" name="code" placeholder="Code (e.g. FNH)" value="{{ code_query }}" class="form-control">
                </div>
                
                <div class="col-md-2">
                    <label class="form-label">Number</label>
                    <input type="text" name="number" placeholder="Number (e.g. 200)" value="{{ number_query }}" class="form-control">
                </div>
                
                <div class="col-md-2">
                    <label class="form-label">Section</label>
                    <input type="text" name="section" placeholder="Section (e.g. 001)" value="{{ section_query }}" class="form-control">
                </div>

                <div class="col-md-3">
                    <label class="form-label">Term</label>
                    <select id="courses-term" name="term" class="form-select" multiple>
                        {% for t in terms %}
                            <option value="{{ t }}" {% if t in term_query %}selected{% endif %}>{{ t }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="col-md-3">
                    <label class="form-label">Day</label>
                    <select id="courses-day" name="day" class="form-select" multiple>
                        {% for d in days %}
                            <option value="{{ d }}" {% if d in day_query %}selected{% endif %}>{{ d }}</option>
                        {% endfor %}
                    </select>
                </div>
              
                <div class="col-md-1">
                    <button type="submit" class="btn btn-primary control-height px-3" name="search" value="1">Search</button>
                </div>

            </form>
              
    </div>

    <div class="d-flex justify-content-between mb-3">
        <a href="{% url 'scheduler:create_course' %}" class="btn btn-success">Add</a>
    </div>

    {% if submitted %}
        <!-- Courses Table -->
        <div class="table-wrapper table-responsive w-10 ml-5 mr-5">
            <table class="table table-bordered table-striped table-hover text-center">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Code</th>
                        <th>Number</th>
                        <th>Section</th>
                        <th>Term</th>
                        <th>Start</th>
                        <th>End</th>
                        <th>Day</th>
                        <th>Academic Year</th>
                        <th>Edit</th>
                    </tr>
                </thead>
                <tbody>
                    {% for course in courses %}
                    <tr>
                        <td>{{ course.id }}</td>
                        <td>{{ course.code }}</td>
                        <td>{{ course.number }}</td>
                        <td>{{ course.section }}</td>
                        <td>{{ course.term }}</td>
                        <td>{{ course.start_time }}</td>
                        <td>{{ course.end_time }}</td>
                        <td>{{ course.day_names|join:','|default:"None" }}</td>
                        <td>{{ course.academic_year }}</td>
                        <td>
                            <a href="{% url 'scheduler:edit_course' course.id %}" class="btn btn-warning btn-sm">Edit</a>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="10">No courses found.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        
        <!--──────── PAGINATION CONTROLS ────────-->
        <div class="pagination-container mt-3 d-flex justify-content-center">
            <nav aria-label="Course pagination">
            <ul class="pagination">
        
                {% if page_obj.has_previous %}
                <li class="page-item">
                    <a class="page-link"
                    href="?{{ querystring }}&page={{ page_obj.previous_page_number }}">
                    Previous
                    </a>
                </li>
                {% else %}
                <li class="page-item disabled"><span class="page-link">Previous</span></li>
                {% endif %}
        
                {% for num in page_obj.paginator.page_range %}
                {% if page_obj.number == num %}
                    <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                {% else %}
                    <li class="page-item">
                    <a class="page-link"
                        href="?{{ querystring }}&page={{ num }}">
                        {{ num }}
                    </a>
                    </li>
                {% endif %}
                {% endfor %}
        
                {% if page_obj.has_next %}
                <li class="page-item">
                    <a class="page-link"
                    href="?{{ querystring }}&page={{ page_obj.next_page_number }}">
                    Next
                    </a>
                </li>
                {% else %}
                <li class="page-item disabled"><span class="page-link">Next</span></li>
                {% endif %}
        
            </ul>
            </nav>
        </div> 
    {% endif %}
    
</div>
<script>
    (function(){
        const $term = $('#courses-term');
        if ($term.hasClass('select2-hidden-accessible')) {
            $term.select2('destroy');
        }
        $term.select2({
            placeholder: "Select Terms",
            width: '100%',
            allowClear: true
        });

        const $year = $('#courses-year');
        if ($year.hasClass('select2-hidden-accessible')) {
            $year.select2('destroy');
        }
        $year.select2({ 
            placeholder: "Select Years",
            width: '100%', 
            allowClear: true 
        });

        const $day = $('#courses-day');
        if ($day.hasClass('select2-hidden-accessible')) {
            $day.select2('destroy');
        }
        $day.select2({
            placeholder: "Select Days",
            width: '100%',
            allowClear: true
        });
    })();
</script>
{% endblock %}
